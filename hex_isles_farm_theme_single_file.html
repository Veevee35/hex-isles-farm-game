const playable=pl.dev.some(c=>!c.fresh&&(c.type==='vp'||!State.devPlayed));document.getElementById('playDevBtn').disabled=!playable||block;document.getElementById('moveRobberBtn').disabled=true}<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hex Isles ‚Äî Farm Theme</title>
<style>
:root{--bg:#081014;--panel:#0e1520;--panel-2:#0b121b;--ink:#e6edf3;--muted:#9fb2c4;--brand:#80e7a5;--accent:#ffd166;--danger:#ff6b6b;--stroke:#0a0f14}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#86c5ff 0%,#f0f8ff 35%,#b2e3a1 36%,#0b121b 37%);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
button{appearance:none;border:none;background:linear-gradient(180deg,#1c2a3d,#122033);color:var(--ink);padding:.7rem 1rem;border-radius:14px;cursor:pointer;box-shadow:0 2px 0 #0a111a,0 10px 30px rgba(0,0,0,.25)}
button:hover{transform:translateY(-1px)}
button:disabled{opacity:.45;cursor:not-allowed;transform:none}
.primary{background:linear-gradient(135deg,#31c77a,#9be97b);color:#041218;font-weight:800}
.danger{background:linear-gradient(180deg,#5d2228,#4a1b20)}
.app{display:grid;grid-template-rows:auto 1fr;height:100%}
header{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid #1b2431;background:linear-gradient(180deg,rgba(16,24,36,.92),rgba(10,16,24,.8))}
.badge{font-weight:800;letter-spacing:.08em;font-size:.72rem;opacity:.9;padding:.3rem .55rem;border-radius:999px;background:#162233;border:1px solid #203046}
main{display:grid;grid-template-columns:300px 1fr 360px;gap:12px;padding:12px}
.panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid #1b2431;border-radius:20px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25) inset}
.panel .head{padding:12px 14px;border-bottom:1px solid #1b2431;display:flex;align-items:center;gap:8px}
.panel .body{padding:12px;max-height:calc(100vh - 156px);overflow:auto}
#lobby{max-width:980px;margin:3rem auto;display:grid;gap:14px;grid-template-columns:1fr 1fr}
.card{background:linear-gradient(180deg,#0f1621,#0b121b);border:1px solid #1b2431;border-radius:20px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.25) inset}
input,select{width:100%;padding:.8rem .9rem;border-radius:12px;border:1px solid #203040;background:#0f1621;color:var(--ink)}
label{display:block;color:var(--muted);font-size:.85rem;margin-bottom:.35rem}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row{display:flex;gap:10px;align-items:center}
.stack{display:grid;gap:10px}
.player-chip{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#0f1621;border:1px solid #203040;border-radius:14px}
.swatch{width:18px;height:18px;border-radius:6px}
#board{width:100%;height:calc(100vh - 200px);background:radial-gradient(1200px 800px at 30% 5%,#0b1623,#09131c 60%);border-radius:20px;box-shadow:inset 0 0 80px rgba(0,0,0,.35)}
svg{width:100%;height:100%}
.tile{stroke:var(--stroke);stroke-width:2}
.token circle{fill:#f4e0b6}
.token text{fill:#1b1e22;font-weight:900;font-size:16px}
.pip{fill:#1b1e22}
.vertex-hit{fill:transparent;stroke:transparent;cursor:pointer}
.edge-hit{stroke-width:16;stroke:#0000;pointer-events:stroke;cursor:pointer}
.fence-rail{stroke:#8b5e3c;stroke-width:10;stroke-linecap:round;filter:drop-shadow(0 1px 0 rgba(0,0,0,.3))}
.fence-post{fill:#8b5e3c;stroke:#3a2a1b;stroke-width:1}
.port text{font-weight:900;font-size:14px}
.coast{fill:none;stroke:rgba(102,217,232,.22);stroke-width:2;stroke-dasharray:10 14}
.coast2{stroke:rgba(102,217,232,.12);stroke-width:2;stroke-dasharray:6 10}
.coast3{stroke:rgba(102,217,232,.07);stroke-width:2;stroke-dasharray:14 16}
.hand{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.rcard{background:#0f1621;border:1px solid #203040;border-radius:14px;padding:10px;text-align:center}
.rcard .n{font-weight:900;font-size:18px}
.rcard .icon{font-size:16px;opacity:.9}
.devbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.devchip{background:#162233;border:1px solid #203046;border-radius:14px;padding:6px 10px;font-weight:700}
.dice{background:#0f1621;border:1px solid #203046;border-radius:14px;overflow:hidden;margin:10px 0}
.dice>summary{padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
#diceLog{padding:10px 12px;max-height:240px;overflow:auto}
.dline{display:flex;gap:8px;align-items:center;padding:4px 0;border-bottom:1px dashed #203046}
.dline:last-child{border-bottom:none}
.log{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap}
@keyframes sway{0%{transform:rotate(-2deg)}100%{transform:rotate(2deg)}}
@keyframes bob{0%{transform:translateY(-1px)}100%{transform:translateY(1px)}}
@keyframes glint{0%,90%{opacity:.15}100%{opacity:.9}}
</style>
</head>
<body>
<div class="app">
<header>
  <div class="row"><span class="badge">Hex Isles</span></div>
  <div class="row">
    <span id="turnInfo" class="badge">Lobby</span>
    <button id="saveBtn">Save</button>
    <button id="loadBtn">Load</button><button id="inviteBtn" class="primary" style="display:none">Invite</button><button id="newBtn" class="danger">New</button>
  </div>
</header>
<div id="lobby" style="display:block" class="card">
  <h2>Create Game</h2>
  <div class="grid">
    <div class="stack">
      <label>Number of players</label>
      <select id="playerCount"><option>2</option><option>3</option><option selected>4</option><option>5</option><option>6</option></select>
    </div>
    <div class="stack">
      <label>Seed</label>
      <input id="seed" placeholder="random"/>
    </div>
  </div>
  <div class="stack" style="margin-top:10px">
    <label>Players</label>
    <div id="playersList" class="stack"></div>
  </div>
  <div class="row" style="margin-top:12px;justify-content:flex-end">
    <button id="startBtn" class="primary">Start</button>
  </div>
</div>
<main id="game" style="display:none">
<section class="panel"><div class="head"><strong>Players</strong></div><div class="body" id="playersPanel"></div></section>
<section class="panel"><div class="head"><strong id="phaseLabel">Setup</strong><span id="modeTag" class="badge">mode: select</span></div><div id="board" class="body"><svg id="svg"></svg></div><div class="row" style="padding:10px 12px;justify-content:space-between"><div class="row" style="gap:8px"><button id="rollBtn" class="primary">Roll</button><button id="endBtn">End</button><span id="lastRoll" class="badge">‚Äî</span></div><div class="row" style="gap:8px"><button id="buildRoadBtn">Road</button><button id="buildSettlementBtn">Settlement</button><button id="buildCityBtn">City</button><button id="buyDevBtn">Buy Dev</button><button id="playDevBtn">Play Dev</button><button id="bankTradeBtn">Bank</button><button id="moveRobberBtn">Robber</button></div></div></section>
<section class="panel"><div class="head"><strong>Hand</strong></div><div class="body"><div id="hand" class="hand" style="margin-bottom:12px"></div><div id="devbar" class="devbar"></div><details class="dice" id="diceDetails"><summary>Dice Log <span id="diceStats" class="badge">‚Äî</span></summary><div id="diceLog" class="log"></div></details><div class="head"><strong>Log</strong></div><div id="log" class="body log"></div></div></section>
</main>
</div>
<dialog id="tradeDlg"><div class="head" style="padding:12px 14px">Bank Trade</div><div class="body" style="padding:12px 14px"><div class="grid"><div><label>Give</label><select id="tradeGive"></select></div><div><label>Receive</label><select id="tradeReceive"></select></div></div></div><div class="row" style="padding:12px 14px;justify-content:flex-end"><button id="tradeCancel">Cancel</button><button id="tradeOk" class="primary">Trade</button></div></dialog>
<dialog id="robDlg"><div class="head" style="padding:12px 14px">Rob</div><div class="body" style="padding:12px 14px"><div id="robList" class="stack"></div></div><div class="row" style="padding:12px 14px;justify-content:flex-end"><button id="robCancel">Cancel</button><button id="robOk" class="primary">Rob</button></div></dialog>
<dialog id="playDevDlg"><div class="head" style="padding:12px 14px">Play Development Card</div><div class="body" style="padding:12px 14px"><div id="playDevList" class="stack"></div></div><div class="row" style="padding:12px 14px;justify-content:flex-end"><button id="playDevCancel">Cancel</button><button id="playDevOk" class="primary">Play</button></div></dialog>
<dialog id="yopDlg"><div class="head" style="padding:12px 14px">Year of Plenty</div><div class="body" style="padding:12px 14px"><div class="grid"><div><label>Resource 1</label><select id="yopA"></select></div><div><label>Resource 2</label><select id="yopB"></select></div></div></div><div class="row" style="padding:12px 14px;justify-content:flex-end"><button id="yopCancel">Cancel</button><button id="yopOk" class="primary">Take</button></div></dialog>
<dialog id="monoDlg"><div class="head" style="padding:12px 14px">Monopoly</div><div class="body" style="padding:12px 14px"><label>Resource</label><select id="monoRes"></select></div><div class="row" style="padding:12px 14px;justify-content:flex-end"><button id="monoCancel">Cancel</button><button id="monoOk" class="primary">Claim</button></div></dialog>
<dialog id="discardDlg"><div class="head" style="padding:12px 14px">Discard</div><div class="body" style="padding:12px 14px"><div id="discardInfo" class="row"></div><div id="discardRows" class="stack"></div></div><div class="row" style="padding:12px 14px;justify-content:flex-end"><button id="discardOk" class="primary" disabled>Discard</button></div></dialog>
<script>
(function(){
const RES=["brick","wood","sheep","wheat","ore"];const ICON={brick:"üß±",wood:"üå≥",sheep:"üêë",wheat:"üåæ",ore:"‚õèÔ∏è"};const COLORS={brick:"#b55a43",wood:"#2e7d32",sheep:"#4aa86a",wheat:"#e0c351",ore:"#597a87",desert:"#d6c7a2"};const COSTS={road:{brick:1,wood:1},settlement:{brick:1,wood:1,sheep:1,wheat:1},city:{ore:3,wheat:2},dev:{sheep:1,wheat:1,ore:1}};
const DEV_NAMES={knight:"Knight",vp:"Victory Point",rb:"Road Building",yop:"Year of Plenty",mono:"Monopoly"};
const State={seed:null,phase:"setup-1",players:[],current:0,lastRoll:null,board:null,robberTile:null,mode:"select",selected:null,log:[],setupStage:1,turns:1,devDeck:[],devPlayed:false,freeRoads:0,discardQueue:[],dice:[],hasRolled:false};
let View={x:0,y:0,w:100,h:100};
const HEX=44;function a2p(q,r){return{x:HEX*(Math.sqrt(3)*q+Math.sqrt(3)/2*r),y:HEX*(1.5*r)}}function hexPts(c){const a=[];for(let i=0;i<6;i++){const ang=Math.PI/180*(60*i-30);a.push([c.x+HEX*Math.cos(ang),c.y+HEX*Math.sin(ang)])}return a}
function coords(shape){if(shape==='big'){const rows=[3,4,5,6,5,4,3],mid=3,out=[];for(let ri=0;ri<rows.length;ri++){const r=ri-mid,L=rows[ri],q0=Math.floor((-r-(L-1))/2);for(let i=0;i<L;i++)out.push([q0+i,r])}return out}else{const rows=[3,4,5,4,3],mid=2,out=[];for(let ri=0;ri<rows.length;ri++){const r=ri-mid,L=rows[ri],q0=Math.floor((-r-(L-1))/2);for(let i=0;i<L;i++)out.push([q0+i,r])}return out}}
function rngFromSeed(n){return function(){var t=n+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
function xmur3(str){for(var i=0,h=1779033703^str.length;i<str.length;i++)h=Math.imul(h^str.charCodeAt(i),3432918353),h=h<<13|h>>>19;return h>>>0}
function shuffle(a,rnd){const rand=typeof rnd==='function'?rnd:Math.random;for(let i=a.length-1;i>0;i--){const j=Math.floor(rand()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function genBoard(seed,size){const seeded=!!seed;const r=seeded?rngFromSeed(xmur3(seed)):Math.random;const big=size==='big';const counts=big?{wood:6,wheat:6,sheep:6,brick:5,ore:5,desert:2}:{wood:4,wheat:4,sheep:4,brick:3,ore:3,desert:1};const cs=coords(big?'big':'base');const key=c=>c[0]+","+c[1];const map=new Map(cs.map((c,i)=>[key(c),i]));const dirs=[[1,0],[1,-1],[0,-1],[-1,0],[-1,1],[0,1]];const adj=cs.map(c=>{const out=[];for(const d of dirs){const nb=[c[0]+d[0],c[1]+d[1]],mi=map.get(key(nb));if(mi!=null)out.push(mi)}return out});const deg=adj.map(a=>a.length);const order=[...cs.keys()].sort((i,j)=>deg[j]-deg[i]);let best=null;for(let attempt=0;attempt<400;attempt++){const resArr=new Array(cs.length).fill(null);const pool=Object.assign({},counts);function choices(){const arr=[];for(const k of Object.keys(pool))if(pool[k]>0)arr.push(k);shuffle(arr,seeded?r:Math.random);return arr}function ok(i,res){if(res!=='desert'){for(const n of adj[i]){if(resArr[n]===res)return false}}return true}function place(idx){if(idx===order.length)return true;const i=order[idx];const opts=choices();for(const res of opts){if(pool[res]===0)continue;if(!ok(i,res))continue;resArr[i]=res;pool[res]--;if(place(idx+1))return true;pool[res]++;resArr[i]=null}return false}if(place(0)){best=resArr;break}}if(!best){const bag=[];Object.entries(counts).forEach(([k,v])=>{for(let i=0;i<v;i++)bag.push(k)});shuffle(bag,seeded?r:Math.random);best=bag}
const tiles=cs.map((qr,i)=>({id:i,qr,res:best[i],num:null}));let deserts=tiles.filter(t=>t.res==='desert').map(t=>t.id);if(deserts.length===0){tiles[Math.floor(tiles.length/2)].res='desert';deserts=[Math.floor(tiles.length/2)]}
const numCounts=big?{2:2,3:3,4:3,5:3,6:3,8:3,9:3,10:3,11:3,12:2}:{2:1,3:2,4:2,5:2,6:2,8:2,9:2,10:2,11:2,12:1};const nums=[];Object.entries(numCounts).forEach(([n,c])=>{for(let i=0;i<c;i++)nums.push(+n)});function shuffleNums(){shuffle(nums,seeded?r:Math.random)}
const hot=new Set([6,8]);let okNums=false;let tries=0;while(!okNums&&tries<3000){tries++;shuffleNums();let idx=0;for(let i=0;i<tiles.length;i++){if(tiles[i].res==='desert')continue;tiles[i].num=nums[idx++]}okNums=true;for(let i=0;i<tiles.length&&okNums;i++){if(tiles[i].res==='desert')continue;if(hot.has(tiles[i].num)){for(const j of adj[i]){if(tiles[j]&&tiles[j].res!=='desert'&&hot.has(tiles[j].num)){okNums=false;break}}}}}
const board={tiles,vertices:{},edges:{},tileVertices:{},ports:[],type:big?'big':'base'};buildGraph(board);placePorts(board);const robId=deserts[0];return{board,rob:robId}}
function buildGraph(b){const vmap=new Map();const verts=[],edges=new Map(),tverts={};function k(pt){return Math.round(pt.x)+"_"+Math.round(pt.y)}b.tiles.forEach(t=>{const c=a2p(t.qr[0],t.qr[1]);const cs=hexPts(c);const vids=[];for(let i=0;i<6;i++){const pt={x:cs[i][0],y:cs[i][1]},kk=k(pt);let id=vmap.get(kk);if(id==null){id=verts.length;vmap.set(kk,id);verts.push({id,x:pt.x,y:pt.y,occ:null,adj:[],edges:[]})}vids.push(id)}tverts[t.id]=vids;for(let i=0;i<6;i++){const a=vids[i],b=vids[(i+1)%6],ek=a<b?a+"-"+b:b+"-"+a;if(!edges.has(ek))edges.set(ek,{id:ek,a,b,occ:null})}});edges.forEach(e=>{verts[e.a].adj.push(e.b);verts[e.b].adj.push(e.a);verts[e.a].edges.push(e.id);verts[e.b].edges.push(e.id)});b.vertices=Object.fromEntries(verts.map(v=>[v.id,v]));b.edges=Object.fromEntries(Array.from(edges.values()).map(e=>[e.id,e]));b.tileVertices=tverts}
function placePorts(b){const cnt=new Map(),border=[];for(const t of b.tiles){const vs=b.tileVertices[t.id];for(let i=0;i<6;i++){const a=vs[i],c=vs[(i+1)%6],k=a<c?a+"-"+c:c+"-"+a;cnt.set(k,(cnt.get(k)||0)+1)}}for(const [k,c] of cnt){if(c===1){const e=b.edges[k],a=b.vertices[e.a],d=b.vertices[e.b],mx=(a.x+d.x)/2,my=(a.y+d.y)/2,ang=Math.atan2(my,mx);border.push({id:k,a:e.a,b:e.b,mx,my,ang})}}border.sort((u,v)=>u.ang-v.ang);const P=b.tiles.length>19?11:9;let types=P===9?["any","any","any","any","wood","brick","sheep","wheat","ore"]:["any","any","any","any","any","any","wood","brick","sheep","wheat","ore"];shuffle(types,Math.random);const step=border.length/P,picked=new Set(),ports=[];for(let i=0;i<P;i++){let idx=Math.floor((i+.5)*step);while(picked.has(idx))idx=(idx+1)%border.length;picked.add(idx);const be=border[idx],len=Math.hypot(be.mx,be.my)||1,ox=be.mx/len*28,oy=be.my/len*28;ports.push({edgeId:be.id,type:types[i%types.length],x:be.mx+ox,y:be.my+oy})}b.ports=ports}
function makePlayer(n,c){return{name:n,color:c,hand:{brick:0,wood:0,sheep:0,wheat:0,ore:0},roads:new Set(),settlements:new Set(),cities:new Set(),points:0,dev:[],knights:0}}
function can(p,c){return Object.entries(c).every(([k,v])=>p.hand[k]>=v)}function pay(p,c){Object.entries(c).forEach(([k,v])=>p.hand[k]-=v)}
const svg=()=>document.getElementById('svg');
function buildDefs(){const d=el('defs',{});function pat(id,w,h,f){const p=el('pattern',{id,width:w,height:h,patternUnits:'userSpaceOnUse'});f(p);d.appendChild(p)}pat('tex-brick',28,20,p=>{p.appendChild(el('rect',{x:0,y:0,width:28,height:20,fill:'#b9413b'}));for(let y=2;y<20;y+=5){p.appendChild(el('rect',{x:0,y,width:28,height:2,fill:'#d86a61'}))}for(let x=3;x<28;x+=7){for(let y=1;y<20;y+=5){p.appendChild(el('circle',{cx:x,cy:y,r:.8,fill:'#702926'}));p.appendChild(el('circle',{cx:x+3,cy:y+3,r:.8,fill:'#702926'}))}}});pat('tex-wood',28,28,p=>{p.appendChild(el('rect',{x:0,y:0,width:28,height:28,fill:'#6bbf5a'}));for(let r=0;r<3;r++){const gx=4+r*9;const g=el('g',{transform:`translate(${gx},6)`});g.appendChild(el('rect',{x:-3,y:6,width:6,height:10,fill:'#7a4e28'}));const crown=el('g',{class:'sway'});crown.appendChild(el('circle',{cx:0,cy:4,r:5,fill:'#2b7a2f'}));crown.appendChild(el('circle',{cx:-4,cy:6,r:4,fill:'#2f8b33'}));crown.appendChild(el('circle',{cx:4,cy:6,r:4,fill:'#2f8b33'}));g.appendChild(crown);p.appendChild(g)}for(let y=0;y<28;y+=7){p.appendChild(el('rect',{x:0,y,width:28,height:1,fill:'#4fa64b',opacity:.4}))}});pat('tex-sheep',24,24,p=>{p.appendChild(el('rect',{x:0,y:0,width:24,height:24,fill:'#7bcf7a'}));for(let i=0;i<3;i++){const sx=6+i*7,sy=6+(i%2)*7;const sheep=el('g',{style:'animation:bob 1.8s ease-in-out infinite alternate'});sheep.appendChild(el('ellipse',{cx:sx,cy:sy,rx:3.6,ry:3,fill:'#fff'}));sheep.appendChild(el('circle',{cx:sx-2.2,cy:sy-1.6,r:1.2,fill:'#222'}));sheep.appendChild(el('circle',{cx:sx-2.6,cy:sy-1.8,r:.5,fill:'#fff'}));p.appendChild(sheep)}p.appendChild(el('path',{d:'M0 18 Q6 16 12 18 T24 18',stroke:'#5fb55b','stroke-width':1.2,fill:'none',opacity:.6}))});pat('tex-wheat',26,26,p=>{p.appendChild(el('rect',{x:0,y:0,width:26,height:26,fill:'#f4d26b'}));for(let x=5;x<=23;x+=6){const stalk=el('g',{transform:`translate(${x},4)`});stalk.appendChild(el('rect',{x:-.8,y:0,width:1.6,height:18,fill:'#d5b74e'}));for(let y=3;y<=15;y+=4){const ear=el('g',{class:'sway',style:'animation-duration:2.4s'});ear.appendChild(el('ellipse',{cx:-2,cy:y,rx:2,ry:1.2,fill:'#fff3a1'}));ear.appendChild(el('ellipse',{cx:2,cy:y+1.2,rx:2,ry:1.2,fill:'#fff3a1'}));stalk.appendChild(ear)}p.appendChild(stalk)}});pat('tex-ore',28,28,p=>{p.appendChild(el('rect',{x:0,y:0,width:28,height:28,fill:'#5c6f7a'}));for(let i=0;i<10;i++){const cx=(i*7)%28,cy=(i*11)%28;p.appendChild(el('circle',{cx,cy,r:2.1,fill:'#2a3b43'}));const gl=el('circle',{cx:cx+1.4,cy:cy+.8,r:1.1,fill:'#a7bac6',opacity:.15});gl.setAttribute('class','gl');p.appendChild(gl)} });pat('tex-desert',24,24,p=>{p.appendChild(el('rect',{x:0,y:0,width:24,height:24,fill:'#f1e29c'}));for(let i=0;i<20;i++){const cx=(i*5)%24,cy=(i*7)%24;p.appendChild(el('path',{d:`M${cx-2} ${cy} q 2 -2 4 0`,stroke:'#d3c27c','stroke-width':1,fill:'none'}))}});return d}
function fitView(){const s=svg();const all=[];State.board.tiles.forEach(t=>{hexPts(a2p(t.qr[0],t.qr[1])).forEach(p=>all.push(p))});if(!all.length){s.setAttribute('viewBox','-400 -300 800 600');return}let minX=1e9,minY=1e9,maxX=-1e9,maxY=-1e9;for(const [x,y] of all){if(x<minX)minX=x;if(y<minY)minY=y;if(x>maxX)maxX=x;if(y>maxY)maxY=y}const pad=60;View.x=minX-pad;View.y=minY-pad;View.w=(maxX-minX)+pad*2;View.h=(maxY-minY)+pad*2;s.setAttribute('viewBox',`${View.x} ${View.y} ${View.w} ${View.h}`)}
function renderAll(){renderPlayers();renderHand();renderDevBar();renderBoard();renderLog();renderDice();renderHud();controls()}
function renderHud(){const cur=State.players[State.current]||{name:'‚Äî'};document.getElementById('turnInfo').textContent=`${cur.name} ‚Ä¢ Turn ${State.turns}`;document.getElementById('modeTag').textContent=`mode: ${State.mode}`;document.getElementById('phaseLabel').textContent=State.phase==='play'?'Play':(State.phase==='setup-1'?'Setup: Settlement #1':'Setup: Settlement #2');document.getElementById('lastRoll').textContent=State.lastRoll?`last: ${State.lastRoll}`:'‚Äî'}
function renderPlayers(){const p=document.getElementById('playersPanel');p.innerHTML='';State.players.forEach((pl,i)=>{const el=document.createElement('div');el.className='player-chip';const vp=pl.points+(pl.settlements.size+pl.cities.size*2);el.innerHTML=`<div class="swatch" style="background:${pl.color}"></div><div style="flex:1"><div style="font-weight:800">${pl.name}${i===State.current?' <span class=badge>current</span>':''}</div><div class="hint">VP: ${vp}</div></div><div class=hint>R:${pl.roads.size} S:${pl.settlements.size} C:${pl.cities.size}</div>`;p.appendChild(el)})}
function renderHand(){const h=document.getElementById('hand');h.innerHTML='';const pl=State.players[State.current]||{hand:{}};RES.forEach(r=>{const d=document.createElement('div');d.className='rcard';d.innerHTML=`<div class=icon>${ICON[r]}</div><div class=n>${(pl.hand&&pl.hand[r])||0}</div><div class=hint>${r}</div>`;h.appendChild(d)})}
function renderDevBar(){const el=document.getElementById('devbar');const pl=State.players[State.current]||{dev:[]};const counts={knight:0,vp:0,rb:0,yop:0,mono:0};pl.dev.forEach(c=>counts[c.type]++);el.innerHTML='';Object.entries(counts).forEach(([k,v])=>{if(v>0){const chip=document.createElement('div');chip.className='devchip';chip.textContent=`${DEV_NAMES[k]} √ó ${v}`;el.appendChild(chip)}})}
function renderLog(){document.getElementById('log').textContent=State.log.join('\n\n')}
function renderDice(){const c=document.getElementById('diceLog');const stat=document.getElementById('diceStats');if(!c||!stat)return;const a=State.dice||[];c.innerHTML=a.map(e=>{const name=(State.players[e.p]||{}).name||'?';return `<div class="dline"><span class="badge">T${e.turn}</span><span>${name}</span><span>rolled</span><span class="badge">${e.a}</span>+<span class="badge">${e.b}</span>=<strong>${e.sum}</strong></div>`}).join('');stat.textContent=a.length?`last: ${a[0].sum}`:'‚Äî'}
function el(tag,attrs={},text){const n=document.createElementNS('http://www.w3.org/2000/svg',tag);Object.entries(attrs).forEach(([k,v])=>n.setAttribute(k,String(v)));if(text!=null)n.textContent=String(text);return n}
function drawFence(g,a,b,color){const nx=b.x-a.x,ny=b.y-a.y,len=Math.hypot(nx,ny)||1;const ang=Math.atan2(ny,nx)*180/Math.PI;g.appendChild(el('line',{x1:a.x,y1:a.y,x2:b.x,y2:b.y,class:'fence-rail'}));const posts=Math.max(3,Math.floor(len/22));for(let i=0;i<=posts;i++){const t=i/posts;const px=a.x+nx*t,py=a.y+ny*t;g.appendChild(el('rect',{x:px-3.5,y:py-6,width:7,height:12,rx:2,ry:2,transform:`rotate(${ang} ${px} ${py})`,class:'fence-post',fill:color}))}}
function drawBarn(x,y,color){const g=el('g',{});g.appendChild(el('rect',{x:x-10,y:y-9,width:20,height:14,rx:2,fill:color,stroke:'#1b1e22','stroke-width':1.5}));g.appendChild(el('polygon',{points:`${x-12},${y-9} ${x},${y-15} ${x+12},${y-9}`,fill:'#7a2f2f',stroke:'#1b1e22','stroke-width':1.5}));g.appendChild(el('rect',{x:x-4,y:y-1,width:8,height:6,fill:'#1b1e22'}));return g}
function drawCity(x,y,color){const g=el('g',{});g.appendChild(drawBarn(x-3,y,color));g.appendChild(el('rect',{x:x+6,y:y-14,width:9,height:18,rx:3,fill:'#cfd6de',stroke:'#1b1e22','stroke-width':1.5}));g.appendChild(el('circle',{cx:x+10.5,cy:y-14,r:4.5,fill:'#dfe6ee',stroke:'#1b1e22','stroke-width':1.5}));return g}
function renderBoard(){const s=svg();s.innerHTML='';fitView();const defs=buildDefs();s.appendChild(defs);const gMain=el('g',{});const centers=[];State.board.tiles.forEach(t=>{const c=a2p(t.qr[0],t.qr[1]);centers.push(c);const pts=hexPts(c);const base=el('polygon',{class:'tile',points:pts.map(p=>p.join(',')).join(' '),fill:`url(#tex-${t.res})`,stroke:'#0a0f14','stroke-width':'2','data-tile':t.id});gMain.appendChild(base);if(t.num){const tok=el('g',{class:'token'});tok.appendChild(el('circle',{cx:c.x,cy:c.y,r:18,fill:'#f4e0b6',stroke:'#8d6b3b','stroke-width':'2'}));tok.appendChild(el('text',{x:c.x,y:c.y+4,'text-anchor':'middle'},String(t.num)));const pc={2:1,3:2,4:3,5:4,6:5,8:5,9:4,10:3,11:2,12:1}[t.num]||0;for(let i=0;i<pc;i++){const px=c.x+(i-(pc-1)/2)*4.2,py=c.y+12;tok.appendChild(el('circle',{cx:px,cy:py,r:1.7,class:'pip'}))}gMain.appendChild(tok)}if(t.id===State.robberTile){const r=el('g',{});r.appendChild(el('circle',{cx:c.x,cy:c.y,r:19,fill:'#333',stroke:'#000','stroke-width':2}));r.appendChild(el('text',{x:c.x,y:c.y+6,'text-anchor':'middle',fill:'#eee','font-weight':'800'},'üßë‚Äçüåæ'));gMain.appendChild(r)}});Object.values(State.board.edges).forEach(e=>{const a=State.board.vertices[e.a],b=State.board.vertices[e.b];if(e.occ!=null){const owner=State.players[e.occ];drawFence(gMain,a,b,owner.color)}gMain.appendChild(el('line',{x1:a.x,y1:a.y,x2:b.x,y2:b.y,class:'edge-hit','data-edge':e.id,stroke:'#000','stroke-opacity':'0.001'}))});Object.values(State.board.vertices).forEach(v=>{if(v.occ){const owner=State.players[v.occ.player];if(v.occ.type==='city'){gMain.appendChild(drawCity(v.x,v.y,owner.color))}else{gMain.appendChild(drawBarn(v.x,v.y,owner.color))}}gMain.appendChild(el('circle',{cx:v.x,cy:v.y,r:12,class:'vertex-hit','data-vertex':v.id}))});s.appendChild(gMain);const gPorts=el('g',{class:'port'});(State.board.ports||[]).forEach(p=>{const e=State.board.edges[p.edgeId];if(!e)return;const a=State.board.vertices[e.a],b=State.board.vertices[e.b];const ang=Math.atan2(b.y-a.y,b.x-a.x)*180/Math.PI;const icon=p.type==='any'?'‚õµ':(ICON[p.type]||'?');const rate=p.type==='any'?'3:1':'2:1';const gx=p.x,gy=p.y;const g=el('g',{transform:`translate(${gx},${gy}) rotate(${ang})`,'pointer-events':'none'});g.appendChild(el('rect',{x:-26,y:-14,width:52,height:24,rx:6,fill:'#d8b07a',stroke:'#8d6b3b','stroke-width':1.5,opacity:.95}));g.appendChild(el('text',{x:-6,y:0,'text-anchor':'end','dominant-baseline':'middle',fill:'#1b1e22','font-weight':'900'},icon));g.appendChild(el('text',{x:6,y:0,'text-anchor':'start','dominant-baseline':'middle',fill:'#1b1e22','font-weight':'900'},rate));gPorts.appendChild(g);gPorts.appendChild(el('line',{x1:gx,y1:gy,x2:(a.x+b.x)/2,y2:(a.y+b.y)/2,stroke:'#d8b07a','stroke-dasharray':'4 4','stroke-width':1,opacity:.6,'pointer-events':'none'}));gPorts.appendChild(el('circle',{cx:a.x,cy:a.y,r:6,fill:'none',stroke:'#d8b07a','stroke-width':2,'pointer-events':'none'}));gPorts.appendChild(el('circle',{cx:b.x,cy:b.y,r:6,fill:'none',stroke:'#d8b07a','stroke-width':2,'pointer-events':'none'}))});s.appendChild(gPorts);let maxr=0;centers.forEach(c=>{hexPts(c).forEach(p=>{const d=Math.hypot(p[0],p[1]);if(d>maxr)maxr=d})});function coast(r){const a=[];for(let i=0;i<6;i++){const ang=Math.PI/180*(60*i-30);a.push([r*Math.cos(ang),r*Math.sin(ang)])}return a.map(p=>p.join(',')).join(' ')}s.appendChild(el('polygon',{points:coast(maxr+20),class:'coast',fill:'none','pointer-events':'none'}));s.appendChild(el('polygon',{points:coast(maxr+60),class:'coast2',fill:'none','pointer-events':'none'}));s.appendChild(el('polygon',{points:coast(maxr+100),class:'coast3',fill:'none','pointer-events':'none'}))}
function log(m){State.log.unshift(m);renderLog()}
function onSvgClick(ev){if(suppressClick){suppressClick=false;return}const t=ev.target;if(t.hasAttribute('data-vertex'))onVertex(+t.getAttribute('data-vertex'));else if(t.hasAttribute('data-edge'))onEdge(t.getAttribute('data-edge'));else if(t.hasAttribute('data-tile')&&State.mode==='move-robber'){moveRobber(+t.getAttribute('data-tile'))}}
function onVertex(id){if(State.mode==='build-settlement')buildSettlement(id);else if(State.mode==='build-city')buildCity(id)}
function onEdge(id){if(State.mode==='build-road')buildRoad(id)}
let isPanning=false,startPt=null,startView=null,suppressClick=false,isDown=false;
function onDown(ev){const t=ev.target;if(t.hasAttribute('data-vertex')||t.hasAttribute('data-edge')){isDown=false;return}isDown=true;isPanning=false;startPt={x:ev.clientX,y:ev.clientY};startView={x:View.x,y:View.y,w:View.w,h:View.h}}
function onMove(ev){if(!isDown&&!isPanning)return;const r=svg().getBoundingClientRect();const dxpx=ev.clientX-startPt.x,dypx=ev.clientY-startPt.y;if(!isPanning&&(Math.abs(dxpx)>3||Math.abs(dypx)>3)){isPanning=true;svg().setPointerCapture(ev.pointerId)}if(!isPanning)return;const dx=dxpx/r.width*View.w,dy=dypx/r.height*View.h;View.x=startView.x-dx;View.y=startView.y-dy;svg().setAttribute('viewBox',`${View.x} ${View.y} ${View.w} ${View.h}`)}
function onUp(ev){if(isPanning){try{svg().releasePointerCapture(ev.pointerId)}catch(e){}suppressClick=true;setTimeout(()=>suppressClick=false,0)}isDown=false;isPanning=false}
function onWheel(ev){ev.preventDefault();const r=svg().getBoundingClientRect();const px=(ev.clientX-r.left)/r.width,py=(ev.clientY-r.top)/r.height;const dir=ev.deltaY>0?1:-1;const k=Math.pow(1.1,dir);let nw=View.w*k,nh=View.h*k;const minW=360,maxW=2600;if(nw<minW){nw=minW;nh=View.h*(minW/View.w)}if(nw>maxW){nw=maxW;nh=View.h*(maxW/View.w)}const dx=(View.w-nw)*px,dy=(View.h-nh)*py;View.x+=dx;View.y+=dy;View.w=nw;View.h=nh;svg().setAttribute('viewBox',`${View.x} ${View.y} ${View.w} ${View.h}`)}
function adjVerts(vId){return State.board.vertices[vId].adj}
function edgesOf(vId){return State.board.vertices[vId].edges}
function tilesAtVertex(vId){const a=[];for(const tid in State.board.tileVertices){if(State.board.tileVertices[tid].includes(vId))a.push(+tid)}return a}
function hasOwnRoad(vId,pid){return edgesOf(vId).some(eid=>State.board.edges[eid].occ===pid)}
function buildSettlement(vId){const v=State.board.vertices[vId],pid=State.current;if(v.occ){log('Spot occupied.');return}if(adjVerts(vId).some(n=>State.board.vertices[n].occ)){log('Too close.');return}if(State.phase==='play'&&!hasOwnRoad(vId,pid)){log('Connect to road.');return}const pl=State.players[pid];if(State.phase==='play'){if(!can(pl,COSTS.settlement)){log('Need resources.');return}pay(pl,COSTS.settlement)}v.occ={player:pid,type:'settlement'};pl.settlements.add(vId);if(State.phase==='setup-2'){const ts=tilesAtVertex(vId);const gain=[];ts.forEach(tid=>{const t=State.board.tiles[tid];if(t&&t.res!=='desert'){pl.hand[t.res]=(pl.hand[t.res]||0)+1;gain.push(t.res)}});if(gain.length)log(`${pl.name} received ${gain.join(', ')}.`)}log(`${pl.name} built settlement.`);if(State.phase.startsWith('setup')){State.mode='build-road';State.selected=vId}renderAll()}
function buildCity(vId){const v=State.board.vertices[vId],pid=State.current,pl=State.players[pid];if(!v.occ||v.occ.player!==pid||v.occ.type!=='settlement'){log('Upgrade your settlement.');return}if(!can(pl,COSTS.city)){log('Need resources.');return}pay(pl,COSTS.city);v.occ.type='city';pl.settlements.delete(vId);pl.cities.add(vId);log(`${pl.name} built city.`);renderAll()}
function buildRoad(eid){const e=State.board.edges[eid],pid=State.current,pl=State.players[pid];if(e.occ!=null){log('Road occupied.');return}const a=State.board.vertices[e.a],b=State.board.vertices[e.b];const touchesVertex=[a,b].some(v=>v.occ&&v.occ.player===pid);const touchesRoad=[a,b].some(v=>v.edges.some(id=>State.board.edges[id].occ===pid));const canConnect=(touchesVertex||touchesRoad);if(State.freeRoads>0&&State.phase==='play'){if(!canConnect){log('Must connect.');return}e.occ=pid;pl.roads.add(eid);State.freeRoads--;log(`${pl.name} placed free road (${2-State.freeRoads}/2).`);if(State.freeRoads===0){State.mode='select'}renderAll();return}
if(State.phase==='play'){if(!canConnect){log('Must connect.');return}if(!can(pl,COSTS.road)){log('Need resources.');return}pay(pl,COSTS.road)}else{if(State.selected==null||(e.a!==State.selected&&e.b!==State.selected)){log('Place next to new settlement.');return}}e.occ=pid;pl.roads.add(eid);log(`${pl.name} built road.`);if(State.phase.startsWith('setup'))advanceSetup();renderAll()}
function advanceSetup(){if(State.phase==='setup-1'){if(State.current<State.players.length-1){State.current+=1;State.mode='build-settlement';State.selected=null}else{State.phase='setup-2';State.mode='build-settlement';State.selected=null}}else if(State.phase==='setup-2'){if(State.current>0){State.current-=1;State.mode='build-settlement';State.selected=null}else{State.phase='play';State.mode='select'}}}
function nextPlayer(){State.current=(State.current+1)%State.players.length;State.turns+=(State.current===0?1:0);State.devPlayed=false;State.hasRolled=false;State.players.forEach(p=>p.dev.forEach(c=>c.fresh=false));renderAll()}
function roll(){if(State.mode==='move-robber'){log('Move robber first.');return}if(State.hasRolled){log('Already rolled this turn.');return}const a=1+Math.floor(Math.random()*6),b=1+Math.floor(Math.random()*6);const sum=a+b;State.hasRolled=true;State.lastRoll=sum;State.dice.unshift({p:State.current,a,b,sum,turn:State.turns});log(`${State.players[State.current].name} rolled ${a}+${b}=${sum}`);if(sum===7)onSeven();else produce(sum);renderAll()}
function produce(sum){for(const t of State.board.tiles){if(t.num===sum&&t.id!==State.robberTile){const vs=State.board.tileVertices[t.id];for(const vId of vs){const v=State.board.vertices[vId];if(v.occ){const pl=State.players[v.occ.player];const amt=v.occ.type==='city'?2:1;if(t.res!=='desert'){pl.hand[t.res]=(pl.hand[t.res]||0)+amt}}}}}renderHand()}
function onSeven(){startDiscardPhase()}
function startDiscardPhase(){const q=[];State.players.forEach((p,i)=>{let total=0;RES.forEach(r=>total+=(p.hand[r]||0));if(total>7)q.push(i)});if(q.length===0){State.mode='move-robber';controls();renderHud();return}State.discardQueue=q;State.mode='discard';controls();promptDiscardNext()}
function promptDiscardNext(){if(State.discardQueue.length===0){State.mode='move-robber';controls();renderHud();return}openDiscardFor(State.discardQueue[0])}
function openDiscardFor(pid){const p=State.players[pid];let total=0;RES.forEach(r=>total+=(p.hand[r]||0));const need=Math.floor(total/2);const dlg=document.getElementById('discardDlg');const info=document.getElementById('discardInfo');const rows=document.getElementById('discardRows');const ok=document.getElementById('discardOk');const q={brick:0,wood:0,sheep:0,wheat:0,ore:0};const avail={brick:p.hand.brick||0,wood:p.hand.wood||0,sheep:p.hand.sheep||0,wheat:p.hand.wheat||0,ore:p.hand.ore||0};function sum(){return RES.reduce((s,r)=>s+q[r],0)}function update(){info.textContent=`${p.name}: select ${need} to discard (${sum()}/${need})`;ok.disabled=sum()!==need;RES.forEach(r=>{document.getElementById('dq_'+r).textContent=q[r]})}
rows.innerHTML='';RES.forEach(r=>{const row=document.createElement('div');row.className='row';row.innerHTML=`<div style="min-width:120px">${ICON[r]} ${r} (${avail[r]})</div><div class=row><button data-r="${r}" data-d="-1">‚àí</button><span class="badge" id="dq_${r}">0</span><button data-r="${r}" data-d="1">+</button></div>`;rows.appendChild(row)});rows.querySelectorAll('button').forEach(b=>{b.onclick=()=>{const r=b.dataset.r,d=+b.dataset.d;const s=sum();if(d===1){if(q[r]<avail[r]&&s<need)q[r]++}else{if(q[r]>0)q[r]--}update()}});ok.onclick=()=>{RES.forEach(r=>{p.hand[r]=Math.max(0,(p.hand[r]||0)-q[r])});log(`${p.name} discarded ${need}.`);dlg.close();State.discardQueue.shift();renderHand();promptDiscardNext()};dlg.showModal();update()}
function moveRobber(tileId){if(tileId===State.robberTile){log('Robber already there.');return}State.robberTile=tileId;const vics=victimsOnTile(tileId).filter(i=>i!==State.current);if(vics.length===0){log('Robber moved. No one to rob.');State.mode='select';renderAll();return}if(vics.length===1){stealFrom(vics[0]);State.mode='select';renderAll();return}openRobDialog(vics);State.mode='select';renderAll()}
function playerHasPort(pid,type){for(const p of State.board.ports){if(type!=='any'&&p.type!==type)continue;const e=State.board.edges[p.edgeId],a=State.board.vertices[e.a],b=State.board.vertices[e.b];if((a.occ&&a.occ.player===pid)||(b.occ&&b.occ.player===pid))return true}return false}
function bestRate(pid,res){let rate=4;if(playerHasPort(pid,'any'))rate=3;if(playerHasPort(pid,res))rate=2;return rate}
function bankTrade(give,receive){const pl=State.players[State.current];const rate=bestRate(State.current,give);if(give===receive){log('Choose different.');return}if((pl.hand[give]||0)<rate){log(`Need ${rate} ${give}.`);return}pl.hand[give]-=rate;pl.hand[receive]=(pl.hand[receive]||0)+1;log(`${pl.name} traded ${rate} ${give} for 1 ${receive}.`);renderHand()}
function buyDev(){const pl=State.players[State.current];if(State.phase!=='play'){log('Wait until play phase.');return}if(State.mode==='move-robber'){log('Resolve robber.');return}if(State.devDeck.length===0){log('No dev cards left.');return}if(!can(pl,COSTS.dev)){log('Need sheep, wheat, ore.');return}pay(pl,COSTS.dev);const type=State.devDeck.pop();pl.dev.push({type,fresh:true});log(`${pl.name} bought a development card.`);renderDevBar();renderHand();controls()}
function initDevDeck(){const d=[];for(let i=0;i<14;i++)d.push('knight');for(let i=0;i<5;i++)d.push('vp');for(let i=0;i<2;i++)d.push('rb');for(let i=0;i<2;i++)d.push('yop');for(let i=0;i<2;i++)d.push('mono');shuffle(d,Math.random);State.devDeck=d}
function controls(){const play=State.phase==='play',block=State.mode==='move-robber'||State.mode==='discard';document.getElementById('rollBtn').disabled=!play||block||State.hasRolled;const pl=State.players[State.current]||{hand:{},dev:[]};document.getElementById('buildRoadBtn').disabled=!(play&&can(pl,COSTS.road))||block;document.getElementById('buildSettlementBtn').disabled=!(play&&can(pl,COSTS.settlement))||block;document.getElementById('buildCityBtn').disabled=!(play&&can(pl,COSTS.city))||block;document.getElementById('buyDevBtn').disabled=!(play&&can(pl,COSTS.dev))||block;const playable=pl.dev.some(c=>!c.fresh&&(c.type==='vp'||!State.devPlayed));document.getElementById('playDevBtn').disabled=!playable||block}
const $=q=>document.querySelector(q);
function lobby(){const COLORS=['#ff6b6b','#ffd166','#6c5ce7','#00e5ff','#7bd88f','#ffb86b'];const pc=$('#playerCount');const list=$('#playersList');function draw(){list.innerHTML='';const n=+pc.value;for(let i=0;i<n;i++){const row=document.createElement('div');row.className='player-chip';row.innerHTML=`<div class=swatch style=background:${COLORS[i%COLORS.length]}></div><input type=text value="Farmer ${i+1}"/><input type=color value=${COLORS[i%COLORS.length]} style=width:50px>`;list.appendChild(row)}}pc.addEventListener('change',draw);draw();$('#startBtn').onclick=()=>{State.seed=$('#seed').value.trim()||null;const names=[...list.querySelectorAll('input[type="text"]')].map(i=>i.value.trim()||'Farmer');const colors=[...list.querySelectorAll('input[type="color"]')].map(i=>i.value);State.players=names.map((n,i)=>makePlayer(n,colors[i]));const n=+pc.value;State.current=0;State.phase='setup-1';State.turns=1;State.lastRoll=null;State.log=[];const gen=genBoard(State.seed,n>=5?'big':'base');State.board=gen.board;State.robberTile=gen.rob;initDevDeck();document.getElementById('lobby').style.display='none';document.getElementById('game').style.display='grid';State.mode='build-settlement';wire();renderAll()}}
function wire(){const s=svg();if(s.dataset.wired)return;s.dataset.wired='1';s.setAttribute('preserveAspectRatio','xMidYMid meet');s.addEventListener('click',onSvgClick);s.addEventListener('pointerdown',onDown);s.addEventListener('pointermove',onMove);s.addEventListener('pointerup',onUp);s.addEventListener('wheel',onWheel,{passive:false});document.getElementById('rollBtn').onclick=()=>{if(State.phase!=='play'){log('Finish setup.');return}if(State.mode==='move-robber'||State.mode==='discard'){log('Resolve current action.');return}roll()};document.getElementById('endBtn').onclick=()=>{if(State.mode==='move-robber'||State.mode==='discard'){log('Resolve current action.');return}if(State.phase.startsWith('setup')){log('Finish setup placement.');return}nextPlayer()};document.getElementById('buildRoadBtn').onclick=()=>{State.mode='build-road';renderHud()};document.getElementById('buildSettlementBtn').onclick=()=>{State.mode='build-settlement';renderHud()};document.getElementById('buildCityBtn').onclick=()=>{State.mode='build-city';renderHud()};document.getElementById('buyDevBtn').onclick=buyDev;document.getElementById('playDevBtn').onclick=openPlayDev;document.getElementById('bankTradeBtn').onclick=openTrade;document.getElementById('moveRobberBtn').onclick=()=>{log('You can only move the robber after rolling a 7.');};document.getElementById('saveBtn').onclick=save;document.getElementById('loadBtn').onclick=load;document.getElementById('newBtn').onclick=()=>location.reload()}
function openTrade(){const pl=State.players[State.current];const g=$('#tradeGive'),r=$('#tradeReceive');g.innerHTML='';r.innerHTML='';RES.forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent=`${x} (${pl.hand[x]||0}, ${bestRate(State.current,x)}:1)`;g.appendChild(o)});RES.forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent=x;r.appendChild(o)});const dlg=document.getElementById('tradeDlg');dlg.showModal();document.getElementById('tradeCancel').onclick=()=>dlg.close();document.getElementById('tradeOk').onclick=()=>{bankTrade(g.value,r.value);dlg.close()}}
function save(){localStorage.setItem('hexisles.save',JSON.stringify(State,(k,v)=>v instanceof Set?{__set:[...v]}:v));log('Saved')}
function load(){const data=localStorage.getItem('hexisles.save');if(!data){log('No save');return}const obj=JSON.parse(data,(k,v)=>v&&v.__set?new Set(v.__set):v);Object.assign(State,obj);document.getElementById('lobby').style.display='none';document.getElementById('game').style.display='grid';wire();renderAll();log('Loaded')}
function toast(m){log(m)}
function victimsOnTile(tileId){const vs=State.board.tileVertices[tileId]||[];const ids=new Set();for(const vId of vs){const v=State.board.vertices[vId];if(v&&v.occ)ids.add(v.occ.player)}return [...ids]}
function stealFrom(victim){const vp=State.players[victim];const cur=State.players[State.current];const pool=[];for(const r of RES){const n=vp.hand[r]||0;for(let i=0;i<n;i++)pool.push(r)}if(pool.length===0){log(`${cur.name} tried to rob ${vp.name} but took nothing.`);return}const res=pool[Math.floor(Math.random()*pool.length)];vp.hand[res]-=1;cur.hand[res]=(cur.hand[res]||0)+1;log(`${cur.name} robbed ${vp.name} and took 1 ${res}.`);renderHand()}
function openRobDialog(vics){const dlg=document.getElementById('robDlg');const list=document.getElementById('robList');list.innerHTML='';vics.forEach((i,idx)=>{const p=State.players[i];const row=document.createElement('label');row.className='player-chip';row.innerHTML=`<input type="radio" name="robVic" value="${i}" ${idx===0?'checked':''}/> <span class=swatch style="background:${p.color}"></span> ${p.name}`;list.appendChild(row)});dlg.showModal();const onCancel=()=>{dlg.close();document.getElementById('robCancel').removeEventListener('click',onCancel);document.getElementById('robOk').removeEventListener('click',onOk)};const onOk=()=>{const sel=list.querySelector('input[name="robVic"]:checked');if(sel){stealFrom(+sel.value)}dlg.close();document.getElementById('robCancel').removeEventListener('click',onCancel);document.getElementById('robOk').removeEventListener('click',onOk)};document.getElementById('robCancel').addEventListener('click',onCancel);document.getElementById('robOk').addEventListener('click',onOk)}
function openPlayDev(){const pl=State.players[State.current];const playable=pl.dev.filter(c=>!c.fresh&&(c.type==='vp'||!State.devPlayed));if(playable.length===0){log('No playable development cards.');return}const list=document.getElementById('playDevList');list.innerHTML='';playable.forEach((c,idx)=>{const row=document.createElement('label');row.className='player-chip';row.innerHTML=`<input type="radio" name="devPick" value="${idx}" ${idx===0?'checked':''}/> ${DEV_NAMES[c.type]}`;list.appendChild(row)});const dlg=document.getElementById('playDevDlg');dlg.showModal();const onCancel=()=>{dlg.close();document.getElementById('playDevCancel').removeEventListener('click',onCancel);document.getElementById('playDevOk').removeEventListener('click',onOk)};const onOk=()=>{const sel=list.querySelector('input[name="devPick"]:checked');if(!sel){onCancel();return}const pick=playable[+sel.value];playDevCard(pick);dlg.close();document.getElementById('playDevCancel').removeEventListener('click',onCancel);document.getElementById('playDevOk').removeEventListener('click',onOk)};document.getElementById('playDevCancel').addEventListener('click',onCancel);document.getElementById('playDevOk').addEventListener('click',onOk)}
function removeDev(pl,type){const i=pl.dev.findIndex(c=>c.type===type&&!c.fresh);if(i>=0)pl.dev.splice(i,1)}
function playDevCard(card){const pl=State.players[State.current];if(card.type==='vp'){pl.points+=1;removeDev(pl,'vp');log(`${pl.name} revealed a Victory Point.`);renderPlayers();renderDevBar();return}if(State.devPlayed){log('Already played a development card this turn.');return}if(card.type==='knight'){removeDev(pl,'knight');pl.knights+=1;State.mode='move-robber';State.devPlayed=true;log(`${pl.name} played Knight.`);controls();renderHud();return}if(card.type==='rb'){removeDev(pl,'rb');State.freeRoads=2;State.mode='build-road';State.devPlayed=true;log(`${pl.name} played Road Building. Place two free roads.`);controls();renderHud();return}if(card.type==='yop'){removeDev(pl,'yop');openYop();State.devPlayed=true;return}if(card.type==='mono'){removeDev(pl,'mono');openMono();State.devPlayed=true;return}}
function fillResSelect(sel){sel.innerHTML='';RES.forEach(r=>{const o=document.createElement('option');o.value=r;o.textContent=r;sel.appendChild(o)})}
function openYop(){const a=document.getElementById('yopA'),b=document.getElementById('yopB');fillResSelect(a);fillResSelect(b);const dlg=document.getElementById('yopDlg');dlg.showModal();const onCancel=()=>{dlg.close();document.getElementById('yopCancel').removeEventListener('click',onCancel);document.getElementById('yopOk').removeEventListener('click',onOk)};const onOk=()=>{const pl=State.players[State.current];[a.value,b.value].forEach(r=>pl.hand[r]=(pl.hand[r]||0)+1);renderHand();log(`${pl.name} took ${a.value} and ${b.value}.`);dlg.close();document.getElementById('yopCancel').removeEventListener('click',onCancel);document.getElementById('yopOk').removeEventListener('click',onOk)};document.getElementById('yopCancel').addEventListener('click',onCancel);document.getElementById('yopOk').addEventListener('click',onOk)}
function openMono(){const sel=document.getElementById('monoRes');fillResSelect(sel);const dlg=document.getElementById('monoDlg');dlg.showModal();const onCancel=()=>{dlg.close();document.getElementById('monoCancel').removeEventListener('click',onCancel);document.getElementById('monoOk').removeEventListener('click',onOk)};const onOk=()=>{const res=sel.value;const cur=State.players[State.current];let taken=0;State.players.forEach((p,i)=>{if(i===State.current)return;const n=p.hand[res]||0;if(n>0){taken+=n;p.hand[res]=0}});cur.hand[res]=(cur.hand[res]||0)+taken;renderHand();log(`${cur.name} claimed ${taken} ${res}.`);dlg.close();document.getElementById('monoCancel').removeEventListener('click',onCancel);document.getElementById('monoOk').removeEventListener('click',onOk)};document.getElementById('monoCancel').addEventListener('click',onCancel);document.getElementById('monoOk').addEventListener('click',onOk)}
initDevDeck();
lobby();
})();
</script>
<script type="module">
const f=window.self!==window.top;
if(f){
  try{
    const {DiscordSDK}=await import('https://cdn.jsdelivr.net/npm/@discord/embedded-app-sdk@2.2.0/output/Discord.mjs');
    const cid=window.DISCORD_CLIENT_ID||'YOUR_CLIENT_ID';
    const sdk=new DiscordSDK(cid);
    await sdk.ready();
    window.discordSdk=sdk;
    const b=document.getElementById('inviteBtn');
    if(b){b.style.display='inline-block';b.onclick=()=>sdk.commands.openInviteDialog();}
    try{await sdk.commands.setActivity({instance_id:'hexisles'});}catch(e){}
  }catch(e){}
}
</script>
</body>
</html>
